# JWT Claim Sub-String Match with ClientID

This example demonstrates how to configure EMQX to authenticate MQTT clients using JWT tokens and validate that the client ID matches a substring extracted from the JWT token's `sub` claim.

## Overview

The authentication mechanism runs in the following order:
1. **Client Info Check (cinfo)**: Extracts the `sub` claim from the JWT token (without full validation), splits it by `:` delimiter, extracts the 4th token, and compares it with the client ID. Denies connection if they don't match.
2. **JWT Authentication**: Validates the JWT token using HMAC-SHA256 with the secret key, checks expiration, and performs full token validation.

## Configuration

The `base.hocon` file configures two authentication mechanisms (executed in order):
1. **Client Info Check (cinfo)**: Extracts the 4th token from the JWT `sub` claim (split by `:`) and compares it with the client ID. This runs before JWT validation and can parse JWT claims from the password field.
2. **JWT Authentication**: Validates the JWT token using HMAC-SHA256 with secret `jwtpassfortest1`, checks expiration, and performs full token validation.

The JWT token's `sub` claim format is: `urn:test:unitid:1001010-1000010:clientid:test`

The 4th token (`1001010-1000010`) must match the client ID for authentication to succeed.

## Files

- `base.hocon`: EMQX configuration file with JWT and client info authentication
- `generate_jwt.py`: Python script to generate JWT tokens with the required claims
- `start-emqx.sh`: Script to start EMQX Docker container and wait for it to be ready
- `pub-ok.sh`: Test script that publishes with a matching client ID (should succeed)
- `pub-fail.sh`: Test script that publishes with a non-matching client ID (should fail)
- `requirements.txt`: Python dependencies

## Usage

1. **Install Python dependencies:**
   ```bash
   pip install -r requirements.txt
   ```

2. **Start EMQX:**
   ```bash
   ./start-emqx.sh
   ```

3. **Test successful authentication:**
   ```bash
   ./pub-ok.sh
   ```
   This uses client ID `1001010-1000010` which matches the 4th token in the JWT `sub` claim.

4. **Test failed authentication:**
   ```bash
   ./pub-fail.sh
   ```
   This uses client ID `randomid1` which does not match the JWT `sub` claim, so authentication should be rejected.

## JWT Token Details

The JWT token generated by `generate_jwt.py`:
- **Algorithm**: HS256 (HMAC-SHA256)
- **Secret**: `jwtpassfortest1`
- **Claims**:
  - `sub`: `urn:test:unitid:1001010-1000010:clientid:test`
  - `iat`: Issued at time
  - `exp`: Expires in 1 hour
  - `nbf`: Not before time
  - `iss`: `test`

## Cleanup

To stop and remove the EMQX container:
```bash
docker stop emqx
docker rm emqx
```
